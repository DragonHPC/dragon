<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Infrastructure Bootstrapping &mdash; Dragon  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Logging" href="logging.html" />
    <link rel="prev" title="Multi Node Deployment" href="multi_node_deployment.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Dragon
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../start/start.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../uguide/uguide.html">Users Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pguide/pguide.html">Programming Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cbook/cbook.html">Solution Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmarks/benchmarks.html">Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ref/ref.html">API Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="infrastructure.html">Infrastructure</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Infrastructure Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="messages_api.html">Infrastructure Messages</a></li>
<li class="toctree-l2"><a class="reference internal" href="processes.html">Process Creation and Interaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="conventional_ids.html">Conventional IDs</a></li>
<li class="toctree-l2"><a class="reference internal" href="single_node_deployment.html">Single Node Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_node_deployment.html">Multi Node Deployment</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Infrastructure Bootstrapping</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#naming-conventions-critical-to-bootstrapping">Naming Conventions Critical to Bootstrapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="#environment-variables-provided-to-shepherd-at-startup">Environment Variables Provided to Shepherd at Startup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mode">MODE</a></li>
<li class="toctree-l4"><a class="reference internal" href="#alloc-sz">ALLOC_SZ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#index">INDEX</a></li>
<li class="toctree-l4"><a class="reference internal" href="#primary-index">PRIMARY_INDEX</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gs-max-msgs-and-sh-max-msgs">GS_MAX_MSGS and SH_MAX_MSGS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#default-seg-sz">DEFAULT_SEG_SZ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#inf-seg-sz">INF_SEG_SZ</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test">TEST</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debug">DEBUG</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#environment-variables-set-by-shepherd">Environment Variables Set by Shepherd</a></li>
<li class="toctree-l3"><a class="reference internal" href="#points-of-consideration">Points of Consideration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="logging.html">Logging</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../services/services.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/components.html">Low-level Components</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Dragon</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="infrastructure.html">Infrastructure</a></li>
      <li class="breadcrumb-item active">Infrastructure Bootstrapping</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/infrastructure/bootstrapping.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="infrastructure-bootstrapping">
<span id="infrastructurebootstrapping"></span><h1>Infrastructure Bootstrapping<a class="headerlink" href="#infrastructure-bootstrapping" title="Permalink to this heading"></a></h1>
<p>This section needs updating.</p>
<p>The information provided in this section is subject to change at any time and should not be used by any <em>user</em>
code.</p>
<p>While the specific steps for bootstrapping the environment are provided here, this is an implementation detail
and no <em>infrastructure</em> code should access these variables directly or depend on the specific details provided
here. Instead, all infrastructure code should use the method described in <a class="reference internal" href="processes.html#accessing-parms"><span class="std std-ref">accessing parameters</span></a> to refer to environment variables as needed by components of the Dragon run-time services.</p>
<p>Some of the parameters listed <a class="reference internal" href="processes.html#parameters"><span class="std std-ref">in the parameters</span></a> must be set by the <a class="reference internal" href="../services/local_services.html#localservices"><span class="std std-ref">Local Services</span></a> during
bringup of the Dragon runtime services. Others are needed by the Shepherd to complete startup of the services.</p>
<p>The <em>MODE</em>, <em>ALLOC_SZ</em>, <em>PRIMARY_INDEX</em>, <em>DEFAULT_SEG_SZ</em>, <em>INF_SEG_SZ</em>, <em>GS_MAX_MSGS</em>, <em>SH_MAX_MSGS</em>, <em>TEST</em>,
and <em>DEBUG</em> environment variables are set by the <a class="reference internal" href="../services/launcher.html#launcher"><span class="std std-ref">Launcher</span></a> and provided to the Shepherd when it is
started. The Shepherd then makes sure that the following list of variables is set for all processes started by
the Dragon Runtime Services and also for <a class="reference internal" href="../services/global_services.html#globalservices"><span class="std std-ref">Global Services</span></a> running on the primary node. The launcher
will then pass those values along during infrastructure startup if certain values are ovverridden.</p>
<p><a href="#id1"><span class="problematic" id="id2">**</span></a>FIXME: These need to be looked at again. **</p>
<ul class="simple">
<li><p>MODE</p></li>
<li><p>ALLOC_SZ</p></li>
<li><p>INDEX</p></li>
<li><dl class="simple">
<dt>PRIMARY_INDEX</dt><dd><ul>
<li><p>DEFAULT_PD</p></li>
<li><p>INF_PD</p></li>
<li><p>LOCAL_SHEP_CD</p></li>
<li><p>LOCAL_BE_CD</p></li>
<li><p>GS_CD</p></li>
<li><p>TEST</p></li>
<li><p>DEBUG</p></li>
<li><p>MY_PUID</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>In addition to these environment variables that are present on back end compute nodes, the Launcher Front End
and the Network Front End communicate through two environment variables, the DRAGON_CTI_EXEC and the
DRAGON_MRNET_EXEC variables. These values are set by the Launcher Front End to tell the Network Front End
code which programs to start when CTI launches its application (the Shepherd) and MRNet Launches its back end.
These two environment variables are only necessary between the Launcher Front End and the Network Front End.</p>
<p>The next sections contain specific details of how bootstrapping the value of these environment variables
differs between single and multinode startup. Each section below provides the details for setting the
environment variables in both modes.</p>
<section id="naming-conventions-critical-to-bootstrapping">
<h2>Naming Conventions Critical to Bootstrapping<a class="headerlink" href="#naming-conventions-critical-to-bootstrapping" title="Permalink to this heading"></a></h2>
<p>There are a few resources that are allocated early on during startup, a phase of bringup informally referred
to as the bootstrapping phase. These naming conventions are documented here.</p>
<ul class="simple">
<li><p>POSIX message queues used during multinode startup are named dragon_&lt;username&gt;_shep_in and
dragon_&lt;username&gt;_shep_out. The two names must be available. Otherwise startup fails. These POSIX message
queues are closed and deleted at teardown of the services.</p></li>
<li><p>The Shepherd names the infrastructure shared memory pool segment as dragon_&lt;username&gt;_inf_shm during
startup. This shared memory segment is deleted at teardown of the services.</p></li>
<li><p>The Shepherd names the default shared memory pool segment used by user processes during interaction with the
runtime services as dragon_&lt;username&gt;_proc_shm during startup. This shared memory segment is deleted at
teardown of the services.</p></li>
</ul>
<p>The &lt;username&gt; is included in the name of these resources to allow multiple users to start the Dragon Runtime
Services simultaneously on a node. This may be advantageous in some circumstances. For instance, a Superdome
processor may allow multiple simultaneous users. A conscious decision was made not to include a time stamp in
naming to prevent an error in programming from consuming all available shared memory segments and/or POSIX
message queues. If there is a bug that causes these resources to remain allocated after Dragon Runtime
Services exit, then we want to know about it as soon as possible.</p>
</section>
<section id="environment-variables-provided-to-shepherd-at-startup">
<h2>Environment Variables Provided to Shepherd at Startup<a class="headerlink" href="#environment-variables-provided-to-shepherd-at-startup" title="Permalink to this heading"></a></h2>
<p>The following environment variables are provided to the Shepherd during startup. For each value, the exact
mechanism of how they are provided is described as well as their purpose.</p>
<section id="mode">
<span id="mode-env"></span><h3>MODE<a class="headerlink" href="#mode" title="Permalink to this heading"></a></h3>
<p>In single-node startup the Shepherd is started by the Launcher back end. When the Launcher back end is started
in single-node mode it will be started by the Launcher with the <em>MODE</em> set to ‘single’. When this is detected,
the Launcher Back End will start the Shepherd with the its <em>MODE</em> environment variable also set to ‘single’.</p>
<p>In multinode startup the Shepherd is started by CTI. The CTI API allows for environment variables to be
set in the daemon process which is the Shepherd for the Dragon runtime services. So, the Launcher, through
CTI, will set the <em>MODE</em> for the Shepherd to ‘mutinode’. In addition, the Launcher Back End is also
started and the mode is passed in as a commandline parameter to the Launcher Back End.</p>
</section>
<section id="alloc-sz">
<span id="id3"></span><h3>ALLOC_SZ<a class="headerlink" href="#alloc-sz" title="Permalink to this heading"></a></h3>
<p>In single-node startup the Shepherd is started by the Launcher back end. When the Launcher back end is started
in single-node mode it will be started by the Launcher with the <em>ALLOC_SZ</em> set to 1. When this is detected,
the Launcher Back End will start the Shepherd with the its <em>ALLOC_SZ</em> environment variable also set to 1.</p>
<p>In multinode startup the Shepherd is started by CTI. The CTI API allows for environment variables to be
set in the daemon process which is the Shepherd for the Dragon runtime services. So, the Launcher, through
CTI, will set the ALLOC_SZ for the Shepherd in the mutinode case.</p>
</section>
<section id="index">
<h3>INDEX<a class="headerlink" href="#index" title="Permalink to this heading"></a></h3>
<p>The <em>INDEX</em> is the node index indicating which of the nodes in the allocation this one is.  The node index
values range from 0 to n-1 in our current implementation (but this could change).</p>
<p>In the mutinode startup the MRNet Server Back End has access to the rank of its node. The MRNet Server
Back End communicates this to the Launcher Back End during startup as the first communication coming through
on its standard output stream. The Launcher Backend reads this value as its first value from the MRNet Server
Back End. It then sends the <em>INDEX</em> value along to the Shepherd in the <em>BENodeIdxSH</em> message on its POSIX
message queue. The Shepherd reads this message as the first step in its preparation for multinode
execution.</p>
<p>In single node startup the Launcher Back End is started by the Launcher. In this case, the Launcher Back End
sends the <em>BENodeIdxSH</em> message to the Shepherd with the value of <strong>INDEX</strong> in it (which will be 0 in this
case).  In the case of single node startup, that message is written to the standard input of the Shepherd
which matches where it expects to find this bootstrap message.</p>
</section>
<section id="primary-index">
<h3>PRIMARY_INDEX<a class="headerlink" href="#primary-index" title="Permalink to this heading"></a></h3>
<p>Setting the <em>PRIMARY_INDEX</em> will be done in the same manner as <a class="reference internal" href="#alloc-sz"><span class="std std-ref">setting the allocation size</span></a>.
In single-node it will be set by the launcher and passed along to the Launcher Back End and the Shepherd. In
mutinode mode it will be set by CTI for the Shepherd.</p>
<p>The <em>PRIMARY_INDEX</em> is hard-coded to 0 by the launcher in our current implementation of the Dragon runtime services.</p>
</section>
<section id="gs-max-msgs-and-sh-max-msgs">
<h3>GS_MAX_MSGS and SH_MAX_MSGS<a class="headerlink" href="#gs-max-msgs-and-sh-max-msgs" title="Permalink to this heading"></a></h3>
<p>These two environment variables are provided by the launcher but at this time are fixed in size. They are provided
to the Shepherd in the same manner as <em>ALLOC_SZ</em>. In single mode the environment variables are set by the Launcher
Back End which has its two copies of the environment variable set by the Launcher. In the mutinode mode, the
two variables are set via CTI.</p>
<p>These two variables are configurable because it is likely that we will want to adjust these values at some
future point depending on characteristics of the system the services are running on.</p>
</section>
<section id="default-seg-sz">
<h3>DEFAULT_SEG_SZ<a class="headerlink" href="#default-seg-sz" title="Permalink to this heading"></a></h3>
<p>The <em>DEFAULT_SEG_SZ</em> is provided by the launcher but is fixed at this time to 1GB.  The <em>DEFAULT_SEG_SZ</em> is
provided to the Shepherd in the same manner the <em>ALLOC_SZ</em> is provided. In single mode the environment
variable is set by the Launcher Back End when the Shepherd is started. In mutinode execution, this
environment variable is set via CTI for the Shepherd. This default segment size is used to determine how big
the pool is for user-level processes when they communicate with the Dragon Runtime Services on the current
node. Each Shepherd instance, and therefore each node, creates its own default segment for shared memory.</p>
</section>
<section id="inf-seg-sz">
<h3>INF_SEG_SZ<a class="headerlink" href="#inf-seg-sz" title="Permalink to this heading"></a></h3>
<p>Like <em>DEFAULT_SEG_SZ</em>, the <em>INF_SEG_SZ</em> is set the same way in single and mutinode modes. The segment
size is used in determining the size of the infrastructure only shared memory pool for the current node to be
used for communication and synchronization of the Dragon Runtime Services on the node. This is defaulted to
1GB presently.</p>
</section>
<section id="test">
<h3>TEST<a class="headerlink" href="#test" title="Permalink to this heading"></a></h3>
<p>The <em>TEST</em> environment variable is set at launch for the Dragon Runtime Services. It defaults to false, but
may be set to true to bypass certain initializations. The <em>TEST</em> environment variable is set via the same
mechanism that <em>ALLOC_SZ</em> and <em>DEFAULT_SEG_SIZE</em> are set through CTI and the Launcher Backend for
mutinode and single mode bootstrapping, respectively.</p>
</section>
<section id="debug">
<h3>DEBUG<a class="headerlink" href="#debug" title="Permalink to this heading"></a></h3>
<p>This is a placeholder for future functionality.</p>
<p>The <em>DEBUG</em> environment variable is set at launch for the Dragon Runtime Services. It defaults to 0, but may
be set to a higher number to increase the verbosity and/or frequency of log entries. The <em>DEBUG</em> environment
variable is set via the same mechanism that <em>ALLOC_SZ</em> and <em>DEFAULT_SEG_SIZE</em> are set through CTI and the
Launcher Backend for mutinode and single mode bootstrapping, respectively.</p>
</section>
</section>
<section id="environment-variables-set-by-shepherd">
<h2>Environment Variables Set by Shepherd<a class="headerlink" href="#environment-variables-set-by-shepherd" title="Permalink to this heading"></a></h2>
<p>The Shepherd sets the following environment variables for Global Services and all user-level processes.  Some
of these values were given to the Shepherd. Other values are created during startup of the Shepherd.  Two of
the values are set on a per process basis.  The values that the Shepherd creates are as follows.</p>
<blockquote>
<div><ul class="simple">
<li><p>LOCAL_SHEP_CD - Channel Descriptor for the Shepherd</p></li>
<li><p>LOCAL_BE_CD - The Launcher Back End Channel Descriptor</p></li>
<li><p>GS_CD  - The Global Services Channel Descriptor</p></li>
<li><p>DEFAULT_PD - The Default Pool Descriptor</p></li>
<li><p>INF_PD - The Infrastructure Pool Descriptor</p></li>
<li><p>GS_RET_CD - This Channel Descriptor is created on a per process basis for responses
to API calls that are processed by Global Services.</p></li>
<li><p>SHEP_RET_CD - This Channel Descriptor is created on a per process basis for responses
to API calls that are processed by the Shepherd (unused).</p></li>
</ul>
</div></blockquote>
<p>Since the Launcher Back End does not have these values given to it through environment variables, they are
passed to the Launcher Back End via the SHPingBE message during startup (excluding the last two which are set
on a per process basis). For all other processes, these are set as environment variables when the process is
started.</p>
<p>In addition, the Shepherd passes along the following environment variables to all processes it creates
including Global Services.</p>
<blockquote>
<div><ul class="simple">
<li><p>MODE</p></li>
<li><p>ALLOC_SZ</p></li>
<li><p>INDEX</p></li>
<li><p>PRIMARY_INDEX</p></li>
<li><p>TEST</p></li>
<li><p>DEBUG</p></li>
<li><p>MY_PUID</p></li>
</ul>
</div></blockquote>
</section>
<section id="points-of-consideration">
<h2>Points of Consideration<a class="headerlink" href="#points-of-consideration" title="Permalink to this heading"></a></h2>
<p>On nodes other than the primary node, we must be able to create a Channel Descriptor for Global Services on
the primary node. This means that the node index must be a part of the creation of a Channel Descriptor and we
should be able to create this descriptor remotely.  This has been written up in JIRA PE-34573.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="multi_node_deployment.html" class="btn btn-neutral float-left" title="Multi Node Deployment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="logging.html" class="btn btn-neutral float-right" title="Logging" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Hewlett Packard Enterprise.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>